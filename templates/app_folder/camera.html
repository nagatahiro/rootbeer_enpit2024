<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="https://cccabinet.jpn.org/bootstrap4/css/style_camera.css">
</head>
<body>

<div class="container mt-5">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
      <button id="back-button" class="btn btn-link">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="navbar-brand">{{ group.name }}：登録画面</span>
    </div>
  </nav>

  <!-- カメラ機能 -->
  <div class="camera-container mt-4">
    <input 
      id="file-input" 
      type="file" 
      accept="image/*" 
      capture="environment" 
      style="display: none;">
    <img id="preview" width="100%" style="display: none;" alt="撮影画像のプレビュー">
    <div class="mt-3">
      <button id="open-camera-button" class="btn btn-lg btn-outline-primary">カメラを開く</button>
      <button id="retry-button" class="btn btn-lg btn-warning" style="display: none;">再撮影</button>
      <button id="extract-button" class="btn btn-lg btn-success" style="display: none;">文字抽出</button>
    </div>
    <div id="result" class="mt-4"></div>
  </div>
</div>

<script>
  const fileInput = document.getElementById('file-input');
  const preview = document.getElementById('preview');
  const openCameraButton = document.getElementById('open-camera-button');
  const retryButton = document.getElementById('retry-button');
  const extractButton = document.getElementById('extract-button');
  const resultDiv = document.getElementById('result');

  document.getElementById('back-button').addEventListener('click', function() {
    window.location.href = "{% url 'app_folder:group_detail' group.id %}";
  });

  // カメラを開くボタン
  openCameraButton.addEventListener('click', () => {
    fileInput.click(); // ファイル選択ダイアログを開く
  });

  // ファイル選択イベント
  fileInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result; // 画像プレビューを表示
        preview.style.display = 'block';
        retryButton.style.display = 'inline-block';
        extractButton.style.display = 'inline-block';
        openCameraButton.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
  });

  // 再撮影
  retryButton.addEventListener('click', () => {
    preview.style.display = 'none'; // プレビューを非表示
    retryButton.style.display = 'none';
    extractButton.style.display = 'none';
    openCameraButton.style.display = 'inline-block';
    fileInput.value = ''; // ファイル入力をリセット
  });

// 文字抽出
extractButton.addEventListener('click', () => {
  if (!preview.src) {
    alert('画像がありません。');
    return;
  }

  // 画像データが設定されていることを確認
  const imageData = preview.src;
  if (!imageData || imageData.indexOf('data:image/jpeg;base64,') !== 0) {
    alert('無効な画像データです。');
    return;
  }

  // Base64エンコードされた画像をBlobに変換
  const byteString = atob(imageData.split(',')[1]);
  const arrayBuffer = new ArrayBuffer(byteString.length);
  const uintArray = new Uint8Array(arrayBuffer);
  for (let i = 0; i < byteString.length; i++) {
    uintArray[i] = byteString.charCodeAt(i);
  }
  const blob = new Blob([uintArray], { type: 'image/jpeg' });
  
  // FormDataを作成して送信
  const formData = new FormData();
  formData.append('image', blob);
  formData.append('group_id', '{{ group.id }}');

  fetch("{% url 'app_folder:photograph' %}", {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      const storeName = data.store_name || "";
      const totalAmount = data.formatted_total || "";

      // shooting_registration.htmlにリダイレクトして、抽出した情報をクエリパラメータとして渡す
      window.location.href = "{% url 'app_folder:shooting_registration' group.id %}?store_name=" + encodeURIComponent(storeName) + "&total_amount=" + encodeURIComponent(totalAmount);
    } else {
      alert(`エラー: ${data.message}`);
    }
  })
  .catch(error => {
    console.error('エラー:', error);
    alert('処理中にエラーが発生しました。');
  });
});

</script>

</body>
</html>
