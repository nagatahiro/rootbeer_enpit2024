<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="stylesheet" href="https://cccabinet.jpn.org/bootstrap4/css/style_camera.css">
</head>
<body>

<div class="container mt-5">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid">
      <button id="back-button" class="btn btn-link">
        <i class="fas fa-arrow-left"></i> 
      </button>
      <span class="navbar-brand">{{ group.name }}：登録画面</span>
    </div>
  </nav>

  <!-- カメラ機能 -->
  <div class="camera-container mt-4">
    <video id="video" width="100%" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>
    <img id="preview" width="100%" style="display: none;" alt="撮影画像のプレビュー">
    <div class="mt-2">
      <button id="capture-button" class="btn btn-outline-primary">撮影</button>
      <button id="retry-button" class="btn btn-warning" style="display: none;">再撮影</button>
      <button id="extract-button" class="btn btn-success" style="display: none;">文字抽出</button>
      <!-- スマホカメラから画像を取得するためのインプット -->
      <input type="file" id="file-input" accept="image/*" capture="camera" style="display:none;">
    </div>
    <div id="result" class="mt-4"></div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    startCamera(); // ページロード時にカメラを自動起動
  });
  
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const captureButton = document.getElementById('capture-button');
  const retryButton = document.getElementById('retry-button');
  const extractButton = document.getElementById('extract-button');
  const fileInput = document.getElementById('file-input');
  const resultDiv = document.getElementById('result');
  const context = canvas.getContext('2d');
  let stream = null;
  
  document.getElementById('back-button').addEventListener('click', function() {
    window.location.href = "{% url 'app_folder:group_detail' group.id %}";
  });
  
  // カメラを起動
  const startCamera = () => {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(cameraStream => {
        stream = cameraStream;
        video.srcObject = stream;
        video.style.display = 'block';
        canvas.style.display = 'none';
        preview.style.display = 'none';
        retryButton.style.display = 'none';
        extractButton.style.display = 'none';
        captureButton.style.display = 'inline-block';
        resultDiv.innerHTML = '';
      })
      .catch(error => {
        console.error("カメラのアクセスに失敗しました:", error);
      });
  };
  
  // カメラを停止
  const stopCamera = () => {
    if (stream) {
      const tracks = stream.getTracks();
      tracks.forEach(track => track.stop());
      stream = null;
    }
  };
  
  // 撮影
  captureButton.addEventListener('click', () => {
    // ビデオのサイズを取得し、キャンバスのサイズを設定
    const videoWidth = video.videoWidth;
    const videoHeight = video.videoHeight;
  
    // キャンバスのサイズをビデオのサイズに合わせる
    canvas.width = videoWidth;
    canvas.height = videoHeight;
  
    // 画像をキャンバスに描画
    context.drawImage(video, 0, 0, videoWidth, videoHeight);
    
    const imageData = canvas.toDataURL('image/jpeg', 1.0);  // 画質を最大（1.0）に設定
    preview.src = imageData;
    video.style.display = 'none';
    preview.style.display = 'block';
    retryButton.style.display = 'inline-block';
    extractButton.style.display = 'inline-block';
    stopCamera();
  });

  // スマホの標準カメラで撮影
  fileInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const imageData = e.target.result;
        
        // キャンバスに画像を描画
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          context.drawImage(img, 0, 0);
          const imageData = canvas.toDataURL('image/jpeg', 1.0);
          preview.src = imageData;
          video.style.display = 'none';
          preview.style.display = 'block';
          retryButton.style.display = 'inline-block';
          extractButton.style.display = 'inline-block';
        };
        img.src = imageData;
      };
      reader.readAsDataURL(file);
    }
  });
  
  // 再撮影
  retryButton.addEventListener('click', () => {
    startCamera(); // カメラを再起動
    preview.style.display = 'none'; // プレビュー画像を非表示
    retryButton.style.display = 'none'; // 再撮影ボタンを非表示
    extractButton.style.display = 'none'; // 文字抽出ボタンを非表示
    fileInput.value = ''; // ファイル入力をリセット
  });
  
  // 文字抽出
  extractButton.addEventListener('click', () => {
    const imageData = canvas.toDataURL('image/jpeg', 1.0);  // 画質を最大（1.0）に設定

    fetch("{% url 'app_folder:photograph' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
        },
        body: new URLSearchParams({
            'image': imageData,
            'group_id': '{{ group.id }}'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const storeName = data.store_name || "";
            const totalAmount = data.formatted_total || "";

            // shooting_registration.htmlにリダイレクトして、抽出した情報をクエリパラメータとして渡す
            window.location.href = "{% url 'app_folder:shooting_registration' group.id %}?store_name=" + encodeURIComponent(storeName) + "&total_amount=" + encodeURIComponent(totalAmount);
        } else {
            alert(`エラー: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('エラー:', error);
        alert('処理中にエラーが発生しました。');
    });
});

</script>

</body>
</html>
